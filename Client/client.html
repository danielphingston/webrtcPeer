<!DOCTYPE html>
<html>
  <head>
    <title>Video Record</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  </head>
  <body>
    <div style="float: left">
      <video id="myVideo" autoplay="autoplay" height="400" width="500"></video>
      <button id="record">Record</button>
      <button id="download">Download</button>
    </div>
    <div style="float: left">
      <video id="player" autoplay="autoplay" height="400" width="500"></video>
      <button id="playBtn">play</button>
    </div>
  </body>
  <script type="text/javascript">
    const video = document.getElementById('myVideo');
    const player = document.getElementById('player');

    const options = {
      OfferToReceiveVideo: true
    };
    var pc = new RTCPeerConnection(options);

    var pc2 = new RTCPeerConnection(options);

    pc2.ontrack = function(e) {
      player.srcObject = e.streams[0];
    };

    let stream;

    //var myChannel = peerCon.createDataChannel('myChannel');

    // pc2.onicecandidate = function(e) {
    //    pc.addIceCandidate(e.candidate);
    //  };

    async function startCapture() {
      if (video.srcObject) {
        let tracks = video.srcObject.getTracks();

        tracks.forEach(track => track.stop());
        video.srcObject = null;
        console.log(tracks);

        //  download(new Blob(chunks), 'recording.webm');
      } else {
        try {
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: true
          });
          video.srcObject = stream;

          stream.getTracks().forEach(track => pc.addTrack(track, stream));
          const url = 'ws://192.168.71.70:3000';

          const connection = new WebSocket(url);

          pc.onicecandidate = function(e) {
            if (e.candidate !== null) connection.send(JSON.parse(e.candidate));
          };

          connection.onmessage = function(event) {
            console.log(event);
            data = JSON.parse(event.data);
            if (data.type === 'candidate') {
              pc.addIceCandidate(data.data);
            } else if (data.type === 'description') {
              pc.setRemoteDescription(data.data);
            }
          };

          connection.onopen = () => {
            pc.createOffer().then(offer => {
              pc.setLocalDescription(offer);
              connection.send(JSON.stringify(pc.localDescription));
            });
          };
        } catch (err) {
          console.log(err);
        }
      }
    }

    function play() {
      pc2
        .setRemoteDescription(pc.localDescription)
        .then(() => pc2.createAnswer())
        .then(answer => {
          pc2.setLocalDescription(answer);
        })
        .then(() => {
          pc.setRemoteDescription(pc2.localDescription);
        })
        .then(() => {})
        .catch(e => console.log('Error: ' + e));
    }

    document.getElementById('record').addEventListener('click', startCapture);
    document.getElementById('download').addEventListener('click', play);
  </script>
</html>
